# Cloud Formation AWS Infra

Minimal private-node Amazon EKS cluster ready for POC.

## Overview

This CloudFormation template provisions:

* A VPC with public and private subnets across two Availability Zones
* Internet Gateway, NAT Gateway, and appropriate route tables
* IAM roles for the EKS control plane and worker nodes
* An Amazon EKS Cluster (`1.30`) with both public and private endpoint access
* An EKS Node Group running in private subnets
* Automatic Helm deployment hooks for Odigos, Prometheus, and Grafana (via Kubernetes Job)

## Prerequisites

* AWS CLI v2 installed and configured with credentials having:

  * CloudFormation permissions
  * EKS & EC2 full access
  * IAM: Create/Attach policies
* `kubectl` installed (to interact with EKS)
* `helm` installed (for manual checks if needed)

## Template Parameters

| Parameter        | Type   | Default                    | Description                        |
| ---------------- | ------ | -------------------------- | ---------------------------------- |
| ClusterName      | String | `q12-poc-cluster` | Name of the EKS cluster and stack  |
| NodeInstanceType | String | `t3.small`                 | EC2 instance type for worker nodes |

## Mappings

| Mapping      | Key      | CidrBlock      |
| ------------ | -------- | -------------- |
| SubnetConfig | PublicA  | `10.0.0.0/19`  |
|              | PublicB  | `10.0.32.0/19` |
|              | PrivateA | `10.0.64.0/19` |
|              | PrivateB | `10.0.96.0/19` |

## Resources

### VPC & Networking

* **VPC** (`10.0.0.0/16`)
* **Public Subnets** in AZs A & B (with Internet Gateway)
* **Private Subnets** in AZs A & B (routed through NAT Gateway)
* **Route Tables** for public and private traffic

### IAM Roles

* **Cluster Role** for EKS control plane
* **Node Role** for EC2 worker nodes with EKS policies and SSM

### EKS Control Plane

* Creates an EKS Cluster with both public and private endpoint access
* Deploys a managed Node Group of `3` nodes (scaling config)

## Outputs

| Output                      | Description                                         |
| --------------------------- | --------------------------------------------------- |
| **ClusterName**             | The name of the Amazon EKS cluster                  |
| **ClusterEndpoint**         | URL endpoint for the EKS API server                 |
| **UpdateKubeconfigCommand** | CLI command to configure `kubectl` for this cluster |
| **NodeGroupName**           | Name of the EKS Node Group                          |

## Deployment

1. Save the CloudFormation template as `cf-aws-infra.yml`.

2. Deploy the stack:

   ```bash
   aws cloudformation deploy \
     --template-file cf-aws-infra.yml \
     --stack-name q12-poc \
     --parameter-overrides ClusterName=my-cluster NodeInstanceType=t3.small \
     --capabilities CAPABILITY_NAMED_IAM
   ```

3. Once the deployment completes, configure `kubectl`:

   ```bash
   aws eks update-kubeconfig --region ${AWS_REGION} --name $(aws cloudformation describe-stacks --stack-name q12-poc --query "Stacks[0].Outputs[?OutputKey=='ClusterName'].OutputValue" --output text)
   ```

4. Verify cluster nodes:

   ```bash
   kubectl get nodes
   ```

## Cleanup

```bash
aws cloudformation delete-stack --stack-name q12-poc
```

---

*Generated by CloudFormation README generator*
